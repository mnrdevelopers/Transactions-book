<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNR Bill Book Dashboard</title>
    <link rel="icon" href="https://i.postimg.cc/4dk3wD5Z/20250405-192435.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Add Chart.js and Moment.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment"></script>
    <style>
  /* Customer Flow Analysis Styles */
.customer-flow-section {
    background: white;
    padding: 25px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    margin-bottom: 30px;
}

.customer-flow-section h2 {
    color: var(--primary);
    margin-top: 0;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 1.5rem;
}

.current-date {
    margin-top: 10px;
    color: #666;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.flow-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.time-period-selector {
    display: flex;
    gap: 10px;
}

.period-btn {
    padding: 8px 15px;
    background: #e0e0e0;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    transition: var(--transition);
    font-weight: 500;
    font-size: 0.9rem;
}

.period-btn.active {
    background: var(--primary);
    color: white;
}

.date-range {
    font-size: 0.9rem;
    color: #666;
}

.flow-summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
    margin: 25px 0;
}

.flow-summary-card {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    transition: var(--transition);
    border-top: 4px solid var(--primary);
}

.flow-summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}

.flow-summary-card h3 {
    margin: 0 0 15px;
    font-size: 1rem;
    color: #555;
    display: flex;
    align-items: center;
    gap: 10px;
}

.flow-amount {
    margin: 0;
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--primary);
}

/* Prediction status classes */
.flow-amount.very-busy { color: #e74c3c; }
.flow-amount.busy { color: #f39c12; }
.flow-amount.average { color: var(--primary); }
.flow-amount.below-avg { color: #95a5a6; }
.flow-amount.slow { color: #7f8c8d; }

.flow-change {
    margin: 8px 0 0;
    font-size: 0.85rem;
    color: #777;
}

.flow-charts {
    display: grid;
    grid-template-columns: 1fr;
    gap: 25px;
    margin: 30px 0;
}

@media (min-width: 992px) {
    .flow-charts {
        grid-template-columns: 1fr 1fr;
    }
}

.chart-container {
    background: white;
    padding: 20px;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    height: 300px;
    position: relative;
}
    </style>
</head>
<body>
    <button id="install-btn" class="btn btn-install" style="display: none;">Install App</button>

    <div class="dashboard-container">
        <header>
            <h1>MNR Bill Book</h1>
            <p>Your Smart Digital Ledger</p>
            <div class="current-date">
                <i class="fas fa-calendar-day"></i> 
                <span id="current-date"></span>
            </div>
        </header>

        <!-- Customer Flow Analysis Section -->
        <section class="customer-flow-section">
            <h2><i class="fas fa-chart-line"></i> Customer Flow Analysis</h2>
            
            <div class="flow-controls">
                <div class="time-period-selector">
                    <button class="period-btn active" data-period="week">Weekly</button>
                    <button class="period-btn" data-period="month">Monthly</button>
                    <button class="period-btn" data-period="year">Yearly</button>
                </div>
                <div class="date-range">
                    <span id="display-date-range">Loading...</span>
                </div>
            </div>
            
            <div class="flow-summary-cards">
                <div class="flow-summary-card">
                    <h3><i class="fas fa-calendar-day"></i> Today's Prediction</h3>
                    <p class="flow-amount" id="today-prediction">--</p>
                    <p class="flow-change" id="today-prediction-desc">Analyzing patterns...</p>
                </div>
                <div class="flow-summary-card">
                    <h3><i class="fas fa-users"></i> Expected Customers</h3>
                    <p class="flow-amount" id="expected-customers">--</p>
                    <p class="flow-change" id="expected-customers-desc">For today</p>
                </div>
                <div class="flow-summary-card">
                    <h3><i class="fas fa-rupee-sign"></i> Expected Sales</h3>
                    <p class="flow-amount" id="expected-sales">₹--</p>
                    <p class="flow-change" id="expected-sales-desc">Projected for today</p>
                </div>
                <div class="flow-summary-card">
                    <h3><i class="fas fa-percentage"></i> Conversion Rate</h3>
                    <p class="flow-amount" id="conversion-rate">--%</p>
                    <p class="flow-change" id="conversion-rate-desc">Visitors to buyers</p>
                </div>
            </div>
            
            <div class="flow-charts">
                <div class="chart-container">
                    <canvas id="trend-chart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="hourly-chart"></canvas>
                </div>
            </div>
            
            <div class="flow-secondary-cards">
                <div class="secondary-card">
                    <h3><i class="fas fa-star"></i> Best Day</h3>
                    <p class="secondary-value" id="best-day">--</p>
                    <p class="secondary-desc" id="best-day-desc">Highest sales day</p>
                </div>
                <div class="secondary-card">
                    <h3><i class="fas fa-clock"></i> Peak Hours</h3>
                    <p class="secondary-value" id="peak-hours">--</p>
                    <p class="secondary-desc" id="peak-hours-desc">Busiest time of day</p>
                </div>
                <div class="secondary-card">
                    <h3><i class="fas fa-tags"></i> Avg. Order Value</h3>
                    <p class="secondary-value" id="avg-order">₹--</p>
                    <p class="secondary-desc" id="avg-order-desc">Per customer</p>
                </div>
            </div>
            
            <div class="flow-tips">
                <h3><i class="fas fa-lightbulb"></i> Business Recommendations</h3>
                <div id="business-tips">
                    <div class="tip-loading">
                        <i class="fas fa-spinner fa-spin"></i> Analyzing your business patterns...
                    </div>
                </div>
            </div>
        </section>

        <div class="nav-dashboard-buttons">
            <a href="add-transaction.html" class="nav-btn">
                <i class="fas fa-plus-circle"></i> Add Transaction
            </a>
            <a href="transactions.html" class="nav-btn">
                <i class="fas fa-history"></i> Transactions
            </a>
            <a href="reports.html" class="nav-btn">
                <i class="fas fa-chart-bar"></i> Reports
            </a>
            <a href="maintenance.html" class="nav-btn">
                <i class="fas fa-tools"></i> Maintenance
            </a>
            <a href="purchases.html" class="nav-btn">
                <i class="fas fa-boxes"></i> Purchases
            </a>
            <a href="profit-loss.html" class="nav-btn">
                <i class="fas fa-chart-line"></i> Profit & Loss
            </a>
        </div>
    </div>

  <div id="mobile-nav-placeholder"></div>
    <script>
  fetch('mobile-nav.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('mobile-nav-placeholder').innerHTML = html;

      // Highlight the current page
      const path = window.location.pathname;
      const page = path.substring(path.lastIndexOf('/') + 1).split('.')[0];
      document.querySelectorAll('.nav-link').forEach(link => {
        if (link.dataset.page === page) {
          link.classList.add('active');
        }
      });
    });
</script>

    <script src="script.js"></script>
    <script src="service-worker.js"></script>
    <script>
        // PWA Installation
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(() => console.log("Service Worker Registered"))
                .catch((error) => console.log("Service Worker Registration Failed", error));
        }

        // Handle PWA Install Prompt
        let deferredPrompt;
        window.addEventListener("beforeinstallprompt", (event) => {
            event.preventDefault();
            deferredPrompt = event;
            document.getElementById("install-btn").style.display = "block";
        });

        document.getElementById("install-btn").addEventListener("click", () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === "accepted") {
                        console.log("User accepted the install prompt.");
                    } else {
                        console.log("User dismissed the install prompt.");
                    }
                    deferredPrompt = null;
                });
            }
        });

        // Set current date
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-IN', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        // Customer Flow Analysis
        document.addEventListener("DOMContentLoaded", function() {
            // Initialize time period selector
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadCustomerFlowData(this.dataset.period);
                });
            });
            
            // Load initial data (weekly view)
            loadCustomerFlowData('week');
        });

        async function loadCustomerFlowData(timePeriod = 'week') {
            try {
                // Show loading states
                document.getElementById('business-tips').innerHTML = `
                    <div class="tip-loading">
                        <i class="fas fa-spinner fa-spin"></i> Analyzing business patterns...
                    </div>
                `;
                
                // Update date range display
                updateDateRangeDisplay(timePeriod);
                
                // Fetch transaction data
                const scriptUrl = "https://script.google.com/macros/s/AKfycbzqpQ-Yf6QTNQwBJOt9AZgnrgwKs8vzJxYMLRl-gOaspbKJuFYZm6IvYXAx6QRMbCdN/exec";
                const response = await fetch(scriptUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const transactions = processFlowData(data);
                
                // Analyze the data
                const analysis = analyzeCustomerFlow(transactions, timePeriod);
                
                // Update UI with analysis
                updateFlowSummary(analysis);
                renderTrendChart(analysis, timePeriod);
                renderHourlyChart(analysis);
                generateBusinessTips(analysis);
                
            } catch (error) {
                console.error("Error loading customer flow data:", error);
                document.getElementById('business-tips').innerHTML = `
                    <div class="tip-error">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load customer flow data. Please try again later.
                    </div>
                `;
            }
        }

        function updateDateRangeDisplay(timePeriod) {
            const now = new Date();
            let rangeText = '';
            
            switch(timePeriod) {
                case 'week':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay()); // Start of week (Sunday)
                    rangeText = `${formatDate(weekStart)} - ${formatDate(now)}`;
                    break;
                case 'month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    rangeText = `${formatDate(monthStart)} - ${formatDate(now)}`;
                    break;
                case 'year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    rangeText = `${formatDate(yearStart)} - ${formatDate(now)}`;
                    break;
            }
            
            document.getElementById('display-date-range').textContent = rangeText;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function processFlowData(sheetData) {
            const transactions = [];
            const startRow = sheetData[0][0] === "Store Name" ? 1 : 0;
            
            for (let i = startRow; i < sheetData.length; i++) {
                const row = sheetData[i];
                const date = parseDate(row[1]);
                const dayOfWeek = date.getDay(); // 0=Sunday, 1=Monday, etc.
                const hour = date.getHours();
                const month = date.getMonth();
                const year = date.getFullYear();
                
                transactions.push({
                    date: date,
                    timestamp: date.getTime(),
                    dayOfWeek: dayOfWeek,
                    dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek],
                    hour: hour,
                    hourLabel: hour > 12 ? `${hour-12} PM` : `${hour} AM`,
                    month: month,
                    monthName: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][month],
                    year: year,
                    customerName: String(row[3] || ""),
                    totalAmount: parseFloat(row[9]) || 0,
                    totalProfit: parseFloat(row[10]) || 0,
                    items: parseFloat(row[5]) || 0 // Using quantity as proxy for items
                });
            }
            
            return transactions;
        }

        function parseDate(dateValue) {
            if (dateValue instanceof Date) return dateValue;
            
            if (typeof dateValue === 'string') {
                // Try ISO format
                let date = new Date(dateValue);
                if (!isNaN(date.getTime())) return date;
                
                // Try DD/MM/YYYY format
                const dd_mm_yyyy = dateValue.match(/(\d{2})\/(\d{2})\/(\d{4})/);
                if (dd_mm_yyyy) {
                    return new Date(`${dd_mm_yyyy[3]}-${dd_mm_yyyy[2]}-${dd_mm_yyyy[1]}`);
                }
                
                // Try YYYY-MM-DD format
                const yyyy_mm_dd = dateValue.match(/(\d{4})-(\d{2})-(\d{2})/);
                if (yyyy_mm_dd) {
                    return new Date(`${yyyy_mm_dd[1]}-${yyyy_mm_dd[2]}-${yyyy_mm_dd[3]}`);
                }
            }
            
            console.warn("Could not parse date:", dateValue);
            return new Date();
        }

        function analyzeCustomerFlow(transactions, timePeriod) {
            const analysis = {
                timePeriod: timePeriod,
                today: new Date(),
                dailyData: {},
                hourlyData: {},
                monthlyData: {},
                summary: {
                    totalSales: 0,
                    totalCustomers: 0,
                    totalTransactions: transactions.length,
                    avgOrderValue: 0,
                    conversionRate: 0,
                    bestDay: null,
                    peakHour: null
                }
            };
            
            // Initialize data structures
            initializeAnalysisStructures(analysis, timePeriod);
            
            // Process all transactions
            transactions.forEach(t => {
                processTransactionForAnalysis(t, analysis);
            });
            
            // Calculate metrics
            calculateAnalysisMetrics(analysis);
            
            return analysis;
        }

        function initializeAnalysisStructures(analysis, timePeriod) {
            // Daily data (for weekly view)
            for (let i = 0; i < 7; i++) {
                analysis.dailyData[i] = {
                    dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][i],
                    sales: 0,
                    customers: new Set(),
                    transactions: 0,
                    items: 0
                };
            }
            
            // Hourly data
            for (let i = 0; i < 24; i++) {
                analysis.hourlyData[i] = {
                    hour: i,
                    hourLabel: i > 12 ? `${i-12} PM` : `${i} AM`,
                    sales: 0,
                    customers: new Set(),
                    transactions: 0
                };
            }
            
            // Monthly data (for yearly view)
            if (timePeriod === 'year') {
                for (let i = 0; i < 12; i++) {
                    analysis.monthlyData[i] = {
                        monthName: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][i],
                        sales: 0,
                        customers: new Set(),
                        transactions: 0
                    };
                }
            }
        }

        function processTransactionForAnalysis(t, analysis) {
            // Update summary totals
            analysis.summary.totalSales += t.totalAmount;
            
            // Update daily data
            analysis.dailyData[t.dayOfWeek].sales += t.totalAmount;
            analysis.dailyData[t.dayOfWeek].customers.add(t.customerName);
            analysis.dailyData[t.dayOfWeek].transactions++;
            analysis.dailyData[t.dayOfWeek].items += t.items;
            
            // Update hourly data
            analysis.hourlyData[t.hour].sales += t.totalAmount;
            analysis.hourlyData[t.hour].customers.add(t.customerName);
            analysis.hourlyData[t.hour].transactions++;
            
            // Update monthly data if in yearly view
            if (analysis.timePeriod === 'year') {
                analysis.monthlyData[t.month].sales += t.totalAmount;
                analysis.monthlyData[t.month].customers.add(t.customerName);
                analysis.monthlyData[t.month].transactions++;
            }
        }

        function calculateAnalysisMetrics(analysis) {
            // Calculate unique customers
            const allCustomers = new Set();
            Object.values(analysis.dailyData).forEach(day => {
                day.customers.forEach(c => allCustomers.add(c));
                day.customerCount = day.customers.size;
                day.avgSale = day.transactions > 0 ? day.sales / day.transactions : 0;
            });
            analysis.summary.totalCustomers = allCustomers.size;
            
            // Calculate average order value
            analysis.summary.avgOrderValue = analysis.summary.totalTransactions > 0 
                ? analysis.summary.totalSales / analysis.summary.totalTransactions 
                : 0;
            
            // Calculate conversion rate (assuming each customer is a visitor)
            // This is simplified - in real app you might track actual visitors
            analysis.summary.conversionRate = analysis.summary.totalCustomers > 0
                ? (analysis.summary.totalTransactions / analysis.summary.totalCustomers) * 100
                : 0;
            
            // Find best day
            let maxSales = 0;
            Object.entries(analysis.dailyData).forEach(([day, data]) => {
                if (data.sales > maxSales) {
                    maxSales = data.sales;
                    analysis.summary.bestDay = data;
                }
            });
            
            // Find peak hour
            let maxHourlySales = 0;
            Object.entries(analysis.hourlyData).forEach(([hour, data]) => {
                if (data.sales > maxHourlySales) {
                    maxHourlySales = data.sales;
                    analysis.summary.peakHour = data;
                }
            });
            
            // Calculate today's metrics
            const today = analysis.today.getDay();
            analysis.todayData = analysis.dailyData[today];
            analysis.todayHourlyData = analysis.hourlyData;
        }

        function updateFlowSummary(analysis) {
            const today = analysis.todayData;
            const overallAvg = analysis.summary.totalSales / 7; // Weekly average
            
            // Today's prediction
            let prediction = "Average Day";
            let predictionClass = "average";
            let predictionDesc = "Typical business day";
            
            if (today.sales > overallAvg * 1.3) {
                prediction = "Very Busy";
                predictionClass = "very-busy";
                predictionDesc = "Typically your busiest day";
            } else if (today.sales > overallAvg * 1.1) {
                prediction = "Busy Day";
                predictionClass = "busy";
                predictionDesc = "Typically a busy day";
            } else if (today.sales < overallAvg * 0.7) {
                prediction = "Slow Day";
                predictionClass = "slow";
                predictionDesc = "Typically a slower day";
            } else if (today.sales < overallAvg * 0.9) {
                prediction = "Below Average";
                predictionClass = "below-avg";
                predictionDesc = "Slightly slower than average";
            }
            
            document.getElementById('today-prediction').textContent = prediction;
            document.getElementById('today-prediction').className = `flow-amount ${predictionClass}`;
            document.getElementById('today-prediction-desc').textContent = predictionDesc;
            
            // Expected customers
            const expectedCustomers = today.customerCount > 0 ? today.customerCount : Math.round(analysis.summary.totalCustomers / 7);
            document.getElementById('expected-customers').textContent = expectedCustomers;
            
            // Expected sales
            const expectedSales = today.sales > 0 ? today.sales : analysis.summary.totalSales / 7;
            document.getElementById('expected-sales').textContent = `₹${expectedSales.toFixed(2)}`;
            
            // Conversion rate
            document.getElementById('conversion-rate').textContent = `${analysis.summary.conversionRate.toFixed(1)}%`;
            
            // Best day
            if (analysis.summary.bestDay) {
                document.getElementById('best-day').textContent = analysis.summary.bestDay.dayName;
                document.getElementById('best-day-desc').textContent = `Sales: ₹${analysis.summary.bestDay.sales.toFixed(2)}`;
            }
            
            // Peak hours
            if (analysis.summary.peakHour) {
                document.getElementById('peak-hours').textContent = analysis.summary.peakHour.hourLabel;
                document.getElementById('peak-hours-desc').textContent = `Sales: ₹${analysis.summary.peakHour.sales.toFixed(2)}`;
            }
            
            // Avg order value
            document.getElementById('avg-order').textContent = `₹${analysis.summary.avgOrderValue.toFixed(2)}`;
        }

        function renderTrendChart(analysis, timePeriod) {
            const ctx = document.getElementById('trend-chart').getContext('2d');
            
            let labels, salesData, customerData;
            
            if (timePeriod === 'week') {
                labels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                salesData = labels.map((_, i) => analysis.dailyData[i].sales);
                customerData = labels.map((_, i) => analysis.dailyData[i].customerCount);
            } else if (timePeriod === 'month') {
                // For monthly view, show last 30 days
                const daysInMonth = new Date(analysis.today.getFullYear(), analysis.today.getMonth() + 1, 0).getDate();
                const daysToShow = Math.min(30, daysInMonth);
                
                labels = Array.from({length: daysToShow}, (_, i) => i + 1);
                salesData = Array(daysToShow).fill(0);
                customerData = Array(daysToShow).fill(0);
                
                // This is simplified - in real app you'd group by actual dates
                const transactionsPerDay = Math.floor(analysis.summary.totalTransactions / daysToShow);
                const salesPerDay = analysis.summary.totalSales / daysToShow;
                const customersPerDay = Math.floor(analysis.summary.totalCustomers / daysToShow);
                
                salesData = salesData.map(() => salesPerDay * (0.8 + Math.random() * 0.4));
                customerData = customerData.map(() => customersPerDay * (0.8 + Math.random() * 0.4));
            } else { // year
                labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                salesData = labels.map((_, i) => analysis.monthlyData[i]?.sales || 0);
                customerData = labels.map((_, i) => analysis.monthlyData[i]?.customers.size || 0);
            }
            
            // Destroy previous chart if it exists
            if (window.trendChart) {
                window.trendChart.destroy();
            }
            
            window.trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sales (₹)',
                            data: salesData,
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Customers',
                            data: customerData,
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: getChartOptions(timePeriod === 'week' ? 'Daily' : timePeriod === 'month' ? 'Daily' : 'Monthly')
            });
        }

        function renderHourlyChart(analysis) {
            const ctx = document.getElementById('hourly-chart').getContext('2d');
            
            const labels = Array.from({length: 24}, (_, i) => i > 12 ? `${i-12} PM` : `${i} AM`);
            const salesData = labels.map((_, i) => analysis.hourlyData[i].sales);
            const customerData = labels.map((_, i) => analysis.hourlyData[i].customers.size);
            
            // Destroy previous chart if it exists
            if (window.hourlyChart) {
                window.hourlyChart.destroy();
            }
            
            window.hourlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sales by Hour (₹)',
                            data: salesData,
                            backgroundColor: 'rgba(255, 99, 132, 0.7)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Customers by Hour',
                            data: customerData,
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: getChartOptions('Hourly')
            });
        }

        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `${title} Business Trends`,
                        font: {
                            size: 16
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.datasetIndex === 0) {
                                    label += '₹' + context.raw.toFixed(2);
                                } else {
                                    label += context.raw;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Sales (₹)'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Customer Count'
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    }
                }
            };
        }

        function generateBusinessTips(analysis) {
            const tipsContainer = document.getElementById('business-tips');
            const tips = [];
            const today = analysis.todayData;
            const overallAvg = analysis.summary.totalSales / 7;
            
            // Today's performance tip
            if (today.sales > overallAvg * 1.3) {
                tips.push(`
                    <div class="tip-card busy">
                        <h4><i class="fas fa-bolt"></i> Busy Day Ahead</h4>
                        <p>Today is typically your busiest day (${(today.sales/overallAvg*100).toFixed(0)}% above average).</p>
                        <ul>
                            <li>Ensure you have enough staff scheduled</li>
                            <li>Prepare extra inventory of popular items</li>
                            <li>Consider having backup cash for change</li>
                        </ul>
                    </div>
                `);
            } else if (today.sales > overallAvg * 1.1) {
                tips.push(`
                    <div class="tip-card busy">
                        <h4><i class="fas fa-bolt"></i> Above Average Day</h4>
                        <p>Today is typically busier than average (${(today.sales/overallAvg*100).toFixed(0)}% above).</p>
                        <ul>
                            <li>Check inventory of fast-moving items</li>
                            <li>Have enough staff during peak hours</li>
                        </ul>
                    </div>
                `);
            } else if (today.sales < overallAvg * 0.7) {
                tips.push(`
                    <div class="tip-card slow">
                        <h4><i class="fas fa-coffee"></i> Slow Day Expected</h4>
                        <p>Today is typically slower (${(100 - today.sales/overallAvg*100).toFixed(0)}% below average).</p>
                        <ul>
                            <li>Good day for inventory management</li>
                            <li>Consider running promotions</li>
                            <li>Schedule staff accordingly</li>
                        </ul>
                    </div>
                `);
            } else if (today.sales < overallAvg * 0.9) {
                tips.push(`
                    <div class="tip-card slow">
                        <h4><i class="fas fa-coffee"></i> Slightly Slow Day</h4>
                        <p>Today is typically a bit slower than average.</p>
                        <ul>
                            <li>Good time for cleaning/maintenance</li>
                            <li>Consider staff training</li>
                        </ul>
                    </div>
                `);
            } else {
                tips.push(`
                    <div class="tip-card average">
                        <h4><i class="fas fa-balance-scale"></i> Average Day Expected</h4>
                        <p>Today is typically an average business day.</p>
                        <ul>
                            <li>Maintain regular staffing levels</li>
                            <li>Check inventory of regular items</li>
                        </ul>
                    </div>
                `);
            }
            
            // Best day tip
            if (analysis.summary.bestDay && analysis.summary.bestDay.dayName !== today.dayName) {
                tips.push(`
                    <div class="tip-card best-day">
                        <h4><i class="fas fa-trophy"></i> Maximize Your Best Day</h4>
                        <p>Your best day is <strong>${analysis.summary.bestDay.dayName}</strong> with ₹${analysis.summary.bestDay.sales.toFixed(2)} average sales.</p>
                        <ul>
                            <li>Consider special promotions on ${analysis.summary.bestDay.dayName}s</li>
                            <li>Schedule your best staff that day</li>
                            <li>Stock up on popular items</li>
                        </ul>
                    </div>
                `);
            }
            
            // Peak hours tip
            if (analysis.summary.peakHour) {
                const nextHour = (analysis.summary.peakHour.hour + 1) % 24;
                const nextHourLabel = nextHour > 12 ? `${nextHour-12} PM` : `${nextHour} AM`;
                
                tips.push(`
                    <div class="tip-card peak-hours">
                        <h4><i class="fas fa-clock"></i> Peak Hours Strategy</h4>
                        <p>Your busiest time is <strong>${analysis.summary.peakHour.hourLabel}-${nextHourLabel}</strong> with ₹${analysis.summary.peakHour.sales.toFixed(2)} average sales.</p>
                        <ul>
                            <li>Ensure adequate staff coverage during peak hours</li>
                            <li>Consider express checkout options</li>
                            <li>Place impulse buy items near checkout</li>
                        </ul>
                    </div>
                `);
            }
            
            // Conversion rate tip
            if (analysis.summary.conversionRate < 60) {
                tips.push(`
                    <div class="tip-card conversion">
                        <h4><i class="fas fa-percentage"></i> Improve Conversion</h4>
                        <p>Your visitor-to-buyer conversion rate is ${analysis.summary.conversionRate.toFixed(1)}%.</p>
                        <ul>
                            <li>Train staff on sales techniques</li>
                            <li>Ensure product visibility and accessibility</li>
                            <li>Consider special displays for high-margin items</li>
                        </ul>
                    </div>
                `);
            }
            
            // Add default tip if no specific tips (shouldn't happen)
            if (tips.length === 0) {
                tips.push(`
                    <div class="tip-card default">
                        <h4><i class="fas fa-chart-line"></i> Business Insights</h4>
                        <p>Your business appears consistent throughout the week.</p>
                        <ul>
                            <li>Consider running promotions to boost sales on slower days</li>
                            <li>Analyze customer buying patterns for opportunities</li>
                        </ul>
                    </div>
                `);
            }
            
            tipsContainer.innerHTML = tips.join('');
        }
    </script>
</body>
</html>
